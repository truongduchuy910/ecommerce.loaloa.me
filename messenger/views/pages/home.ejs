<!DOCTYPE html>
<html>
  <head>
    <% include ../partials/head %>
    <title>Facebook Connect</title>
    <% include ../partials/fb.sdk.ejs %>
    <script>
      class Graph {
        static async execute({ query }) {
          const response = await fetch("https://ad.loaloa.me/admin/api", {
            method: "POST",
            mode: "cors",
            cache: "no-cache",
            credentials: "same-origin",
            headers: {
              "Content-Type": "application/json"
            },
            redirect: "follow",
            referrerPolicy: "no-referrer",
            body: JSON.stringify({ query: query })
          });
          return await response.json();
        }
        constructor() {
          this.gql = new Object();
          this.gql.query;
          this.gql.mutation;
        }
        query({ condition }) {
          console.log(condition);
          return Graph.execute({ query: this.gql.query({ condition }) });
        }
        mutation({ data }) {
          console.log(this.gql.mutation({ data }));
          return Graph.execute({ query: this.gql.mutation({ data }) });
        }
      }
      class Html {
        constructor({ id }) {
          this.isExist = false;
          this.e = document.getElementById(id);

          if (this.e) {
            this.isExist = true;
            console.log("find: ", id);
          }
        }
      }
      class Arrays extends Html {
        constructor({ id }) {
          super({ id });
          if (this.e) {
            this.item = this.e.innerHTML;
            this.e.innerHTML = "";
          }
        }
        add(data) {
          if (this.isExist) {
            let html = this.item;
            data.forEach(({ template, value }) => {
              const regExp = new RegExp(template, "g");
              html = html.replace(regExp, value);
            });
            this.e.innerHTML += html;
          }
        }
        empty() {
          this.e.innerHTML = "";
        }
      }
    </script>
  </head>
  <body>
    <header>
      <!-- Image and text -->
      <nav class="navbar navbar-white bg-white">
        <a class="navbar-brand" href="#">
          <img
            src="/loaloa.png"
            width="30"
            height="30"
            class="d-inline-block align-top"
            alt=""
          />
          Loa Loa Media
        </a>
        <form class="form-inline my-2 my-lg-0">
          <fb:login-button
            scope="public_profile,email,manage_pages"
            onlogin="checkLoginState();"
            auto_logout_link="true"
          >
          </fb:login-button>
        </form>
      </nav>
    </header>
    <main>
      <section class="container">
        <h6>
          Xin chào <span class="badge badge-secondary" id="status"></span>
        </h6>
        <script>
          async function persistent_menu(accessToken) {
            const identity = document.getElementById("identity");

            if (identity && identity.value) {
              let email = identity.value;
              let seller = new Graph();
              console.log(email);
              seller.gql.query = ({ condition }) =>
                `query {
                          allUsers(where: {${condition}}) {
                            id
                          }
                        }
                        `;
              let {
                data: { allUsers }
              } = await seller.query({ condition: `email: "${email}"` });
              const id = allUsers[0].id;
              const path = window.location.origin + "/" + id;
              console.log(path);
              FB.api(
                `/me/messenger_profile`,
                "post",
                {
                  get_started: {
                    payload: "GET_STARTED_PAYLOAD"
                  },
                  whitelisted_domains: [window.location.origin],
                  persistent_menu: [
                    {
                      locale: "default",
                      composer_input_disabled: false,
                      call_to_actions: [
                        {
                          type: "web_url",
                          title: "🛍 Xem sản phẩm",
                          url: path,
                          webview_height_ratio: "tall"
                        }
                      ]
                    },{
                      locale: "default",
                      composer_input_disabled: false,
                      call_to_actions: [
                        {
                          type: "web_url",
                          title: "Tạo cửa hàng",
                          url: "https://ad.loaloa.me",
                          webview_height_ratio: "tall"
                        }
                      ]
                    }

                  ]
                },
                function(response) {
                  console.log(response);
                }
              );
            }
          }
          function run({ response }) {
            const {
              authResponse: { userID, accessToken }
            } = response;
            console.log(`/${userID}/accounts`);
            FB.api(`/${userID}/accounts`, function(
              response
            ) {
              const { data } = response;
              console.log(response);
              let html = "";
              data.forEach(page => {
                html += item
                  .replace(/ten-trang/g, page.name)
                  .replace(/phu-de/g, page.category)
                  .replace(/access-token/g, page.access_token);
              });
              pages.innerHTML = html;
              console.log(item);
              console.log(data);
            });
            FB.api("/me", function(response) {
              console.log(response);
              document.getElementById("status").innerText = response.name;
            });
          }
        </script>
      </section>
      <section class="container">
        <div class="input-group my-3">
          <div class="input-group-prepend">
            <span class="input-group-text" id="basic-addon1">📌</span>
          </div>
          <input
            id="identity"
            type="text"
            class="form-control"
            placeholder="Tên tài khoản..."
            aria-label="Tên tài khoản..."
            aria-describedby="basic-addon1"
          />
        </div>
        <p class="text-secondary">
          Chú thích: Tên tài khoản là tên bạn dùng để đăng nhập vào quản lí sản
          phẩm.
        </p>

        <div id="pages">
          <div class="card my-3">
            <div class="card-body">
              <h5 class="card-title">ten-trang</h5>
              <p class="card-text">phu-de</p>
              <Button
                class="btn btn-sm btn-outline-primary"
                onclick="persistent_menu('access-token')"
                >Kết nối</Button
              >
            </div>
          </div>
        </div>
        <script>
          var pages = document.getElementById("pages");
          var item = pages.innerHTML;
          pages.innerHTML = "";
        </script>
      </section>
    </main>
  </body>
</html>
